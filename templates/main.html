<!DOCTYPE html>
<html dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>CPU</title>
    <script src="/static/underscore-1.2.2.js"></script>
    <script src="/static/jquery-1.6.4.js"></script>
    <script src="/static/jquery.sparkline.min.js"></script>
    <script src="/static/json2.js"></script>
    <script src="/static/backbone.js"></script>
    <script type="text/template" id="group-template">
        <div class="column" id="<%- id %>">
            <h1><%- pos %></h1>
        </div>
    </script>
    <script type="text/template" id="view-template">
        <h2><%- label %></h2>
        <div class='value'><%- value %></div>
        <div class='spark'></div>
    </script>
    <script>
        window.Backbone = Backbone;
        var positions = {{ pos|safe }}

        var Unit = Backbone.Model.extend({
            initialize:function(data) {
                this.set({label:this.label()})
                this.set({date:new Date(data.date)});
                this.bind('change:value',this.changeValue);
                this.query=[0,0,0,0,0,0,0,0,0,0];
            },
            label:function() {
                id = this.get('id').split('_');
                var d = positions[id[0]][id[1]];
                return  d ? d.place + ' ' + d.pos : undefined–∂;
            },
            changeValue:function(){
               this.query = _(this.query).chain().slice(1).push(this.get('value')).value();
            }
        });

        var Data = Backbone.Collection.extend({
            url:'/last/',
            model:Unit
        });

        var View = Backbone.View.extend({
            initialize: function(args){
                _.bindAll(this,'changeValue');
                this.model.bind('change:value',this.changeValue);
                this.model.view = this;
            },
            template: _.template($('#view-template').html()),
            tagName:'div',
            className:'cpu',
            render: function() {
                $(this.el).html(this.template(this.model.toJSON()));
                this.$('.spark').sparkline(this.model.query,{width:'100px'});
                return this;
            },
            changeValue:function(val){
                this.$('.value').html(this.model.get('value'));
                this.$('.spark').sparkline(this.model.query,{width:'100px'});
                this.$('.spark').attr('title',this.model.query.toString())
            }
        });
        window.data = new Data
        window.data.reset({{ data|safe }});

        var WorkSpace = Backbone.Router.extend({
            routes:{
                '!/':'root'
            },
            root:function() {
                window.data.each(function(model) {
                    var el = $('#'+model.get('id'));
                    var v = new View({model:model,el:el});
                    v.render();
                });
            }
        });

        var refresh = function(){
            $.getJSON('/last/').success(function(json){
                _.forEach(json,function(d){
                    data.get(d.id).set({value:d.value});
                });
            });
            setTimeout(refresh,5000);
        }

        var draw = function(){
            var w = [];
            var template = _.template($('#group-template').html());
            for (var m in positions){
                for (var a in positions[m]){
                    var p = positions[m][a].p;
                    var place = positions[m][a].place;
                    var id = m+'_'+a;
                    w.push(id)
                    var gr = $('#'+p).length ?  $('#'+p) : $(template({id:p,pos:place})).appendTo('body');
                    $(gr).append(_.template('<div id="<%- id %>"></div>',{id:id}));
                }
            };
            return w;
        }

        $(function() {
            draw()
            new WorkSpace;
            Backbone.history.start();
            refresh();
        });
    </script>
    <style>
        .column {position: absolute; width: 200px;top:0;}

        #drying_1 {left:200px;}
        #drying_2 {left:400px;}
        #firing {left:0;}

        h1 {font-size: 20px;text-align: center;}
        h2 {font-size: 18px}

        .value {float:left;padding-left: 5px;}
        .spark {width:100px;height:20px;margin-left: 50px;}
    </style>

</head>
<body>
</body>
</html>
