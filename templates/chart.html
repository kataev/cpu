<html dir="ltr">
<head>
    <!DOCTYPE html>
    <meta charset="UTF-8">
    <title>CPU</title>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.6/dojo/dojo.xd.js"
            djConfig="parseOnLoad: true,locale: 'ru'">
    </script>
    <script src="/dojo/dojo.js" djConfig="parseOnLoad: true,locale: 'ru'">
    </script>
    <script type="text/javascript">
        //        dojo.require("dijit.layout.BorderContainer");
        //        dojo.require("dijit.layout.ContentPane");
        dojo.require("dojo.data.ItemFileReadStore");

        dojo.require('dijit.form.Select');
        dojo.require('dijit.form.Button');
        dojo.require('dijit.form.NumberSpinner');

        dojo.require("dojox.charting.widget.Chart2D");
        dojo.require("dojox.charting.widget.Legend");
        dojo.require("dojox.charting.themes.PlotKit.green");
        dojo.require("dojox.charting.themes.Claro");
        dojo.require("dojox.charting.DataSeries");
        dojo.require("dojox.charting.widget.SelectableLegend");
        dojo.require("dijit.form.Form");
        dojo.require("dojo.date.locale");


        dojo.addOnLoad(function() {
            chart = new dojox.charting.Chart2D('chart', null);
            chart.addPlot("default",
                    {
//                         labels: false,
                        type: "Lines",
                        markers: true,
                        tension: "S"

                    });
            var tip = new dojox.charting.action2d.Tooltip(chart, "default");
            var magnify = new dojox.charting.action2d.Magnify(chart, "default");

            chart.setTheme(dojox.charting.themes.Claro);

            chart.addAxis("y", {vertical: true });
            selectableLegend = false;

            var qw = {dvt21:4,dvt22:9,termodat22m:'Термодат'};
            var opt = {temp:'Темп',hmdt:'Влаж'};
            var l = {minute:'минут',hour:'часов',day:'дней',second:'секунд'};

            form = new dijit.form.Form(null, 'form');
            dojo.connect(form, 'onSubmit', function(e) {
//            dojo.stopEvent(e);
                e.preventDefault();
                if (form.isValid()) {
                    var values = form.attr("value");
                } else {
                    return ;
                }
                //'../store_avg/dvt22/minute/20/'
                var i;
                i = 0;
                var url = '../store_avg/' + values.model + '/' + values.group + '/' + values.limit + '/';
                dojo.xhrGet({'url':url,handleAs:'json'}).then(function(data) {
                    var store = new dojo.data.ItemFileReadStore({'data':data});


                    var labelfTime = function(o) {
                        var d = ''
//                        console.log(o);
                        var dt = new Date(o);
//                        console.log(dt)
                        d = dojo.date.locale.format(dt, {
                                    selector: "date",
                                    formatLength: "short",
                                    locale: "ru",
                                    datePattern: 'h:m:s'
                                });
                    };

                    chart.addAxis("x", { labelFunc: labelfTime });

                    var s = chart.addSeries(qw[values.model] + ' ' + opt[values.field] + ' за ' + values.limit + ' ' + l[values.group],
                            new dojox.charting.DataSeries(
                                    store, {query: {id: "*"}
                                            }, function(store, item) {
                                        var o = {
                                            x: ++i,//store.getValue(item, 'id'),
                                            y: store.getValue(item, values.field),
                                            tooltip: dojo.date.locale.format(new Date(store.getValue(item, 'date')), {
                                                        selector: "date",
                                                        formatLength: "short",
                                                        locale: "ru",
                                                        datePattern: (values.group == 'second') ? 'd MMM h:m:s' : 'd MMM h:m'
                                                    })
                                        };
                                        return o;
                                    }));

                    chart.render();
                    if (selectableLegend) {
                        selectableLegend.refresh()
                    }
                    else {
                        selectableLegend = new dojox.charting.widget.SelectableLegend({'chart': chart, outline: true}, "selectableLegend");
                    }

                });
            })

        })
                ;

    </script>
    <style>
        @import "http://ajax.googleapis.com/ajax/libs/dojo/1.6/dijit/themes/claro/claro.css";

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            font-size: 12px;
        }

        input {
            width: 100px;
        }

        label {
            clear: left; /*width: 20px;*/
        /*float: left;*/
        /*text-align: right;*/
        /*margin-right: 5px;*/
        /*vertical-align: middle;*/
        }

        ul {
            list-style-type: none;
            width: 500px;
            padding-left: 0px;
            padding-top: 0px;
            margin-left: 0px;
            margin-top: 0px;
        }

        li {
            float: left;
            height: 30px;

        }

        .dojoxLegendText {
            font-size: 12px;
            padding-left: 4px;
        }

    </style>

</head>
<body class="claro">

<div style='width:200px;height:130px;float:left;padding:2px;'>
    <form id='form' action="" method="">
        <ul style='width:180px;'>
            {#                <li></li>#}
            <li><label>Позиция</label>
                <select name='model' dojoType="dijit.form.Select">
                    {% for a in models %}
                        <option value='{{ a }}'>{{ a.position }}</option>
                    {% endfor %}
                </select></li>
            <li>
                <label>Значение</label>
                <select name='field' dojoType="dijit.form.Select">
                    {% for v in options %}
                        <option value={{ v.value }}>{{ v.label }}</option>
                    {% endfor %}
                </select></li>
            <li><label>Усреднять по</label>
                <select name='group' dojoType="dijit.form.Select">
                    <option value='day'>Дням</option>
                    <option value='hour'>Часам</option>
                    <option value='minute' selected='selected'>Минутам</option>
                    <option value='second'>Секундам</option>
                </select></li>
            <li>
                <label>Предел</label>
                <input name='limit' style='width:50px;' value='10' dojoType="dijit.form.NumberSpinner">
            </li>
            <br>
            <li>
                <button dojoType="dijit.form.Button" type='submit'>Добавить</button>
            </li>
        </ul>
    </form>
</div>

<div id='selectableLegend' style='width:300px;float:left;'></div>

<div id='chart' style='clear:left;'></div>


</div>
</body>
</html>